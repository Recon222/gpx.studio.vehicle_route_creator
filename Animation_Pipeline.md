# Animation Pipeline

## Route Creation and Point Generation

### Anchor Points
- Anchor points are the main control points placed by users
- Each anchor point has an assigned timestamp
- Timestamps on anchor points are used for timing control in the animation

### Dense Points
- Generated automatically between anchor points
- Two methods of generation:
  1. **BRouter (Primary Method)**
     - Used when routing is enabled
     - Points are generated by BRouter's routing engine
     - Follows actual road networks
     - Density is determined by BRouter for accurate road following
  
  2. **Straight-Line (Fallback Method)**
     - Used when routing is disabled
     - Generates points every 50m (0.05km)
     - Simple linear interpolation between anchor points

### Point Generation Triggers
Dense points are regenerated when:
- New anchor points are added
- Existing anchor points are moved
- Routing profile is changed
- Route is recalculated

## Timing and Animation

### Timestamp Management
- Only anchor points have timestamps
- Dense points do not carry timestamps
- Animation engine interpolates timing between anchor points
- Speed is calculated using distance/time between anchor points

### Point Reduction (Optional)
- Post-processing tool using Ramer-Douglas-Peucker algorithm
- Controlled by minify slider (tolerance: 0.1m to 10km)
- Two stages:
  1. Preview: Shows simplified route without modifying data
     - Only affects visual preview on the map
     - Does not affect the actual points used by animation
  2. Application: Permanently reduces points when "Reduce" button is clicked
     - Creates new set of actual route points
     - These new reduced points become what the animation engine uses
- Affects number of points animation engine interpolates between ONLY after applying reduction
- Can impact animation smoothness if used aggressively

## Animation Engine Integration
- Uses the actual route points stored in the track data
- Preview states (like the minify preview) do not affect animation
- Only uses points that have been permanently applied to the route
- Time-based interpolation:
  - Anchor points define the timing (e.g., Point A at 1:00 PM, Point B at 1:10 PM)
  - Dense points between anchors have known positions but no timestamps
  - Animation engine calculates when to be at each dense point by:
    1. Using the time difference between surrounding anchor points
    2. Considering the distance between points
    3. Ensuring smooth movement along the route
- No regeneration of points needed during playback
- Play button initiates animation using existing route data 

## Pipeline Sequence
```
User Action                 Component/File                      Function/Action
--------------------------------------------------------------------------------
Place Anchor               RoutingControls.ts                  addAnchorPoint()
   |                             |                                    |
   |                             v                                    |
   |                      Fetch route from BRouter             route(points)
   |                             |                                    |
   |                             v                                    |
   |                      Generate dense points          getRoute() or getIntermediatePoints()
   |                             |                                    |
   |                             v                                    |
   |                      Update route visualization        replaceTrackPoints()
   |                             |                                    |
Set Timestamp             AnchorTimingStore.ts            updateAnchorTiming()
   |                             |                                    |
   |                             v                                    |
   |                      Validate timestamp order     validateAnchorTimingOrder()
   |                             |                                    |
   |                             v                                    |
   |                      Calculate speed between        calculateSpeed()
   |                      anchor points                               |
   |                             |                                    |
[Optional]                       |                                    |
Reduce Points              Reduce.svelte                    ramerDouglasPeucker()
   |                             |                                    |
   |                             v                                    |
   |                      Preview simplified route           update()
   |                             |                                    |
   |                             v                                    |
   |                      Apply reduction (if clicked)       reduce()
   |                             |                                    |
Press Play                 animation.ts                     startAnimation()
   |                             |                                    |
   |                             v                                    |
   |                      Begin interpolation              interpolate()
   |                      between points                              |
   |                             |                                    |
   |                             v                                    |
   |                      Update vehicle position     updateVehiclePosition()
   |                      based on timestamps                         |
--------------------------------------------------------------------------------
```

Note: This diagram shows the main pipeline flow. Each step may trigger additional helper functions or state updates not shown here for clarity. 